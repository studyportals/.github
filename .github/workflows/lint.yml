name: Reusable Linting

on:
  workflow_call:
    inputs:
      node-version:
        required: false
        default: "20"
        type: string
      php-version:
        required: false
        default: "7.4"
        type: string
      validate-php-phpmd:
        required: false
        default: false
        type: boolean

permissions:
  contents: read
  packages: read
  actions: read
  statuses: write

jobs:
  lint:
    runs-on: ubuntu-22.04
    name: Lint
    timeout-minutes: 30
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - id: files
      uses: studyportals/get-changed-files@main
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        format: csv
        extensions: ".php"
      if: inputs.validate-php-phpmd

    - uses: actions/setup-node@v4
      with:
        node-version: ${{ inputs.node-version }}

    - uses: shivammathur/setup-php@v2
      with:
        php-version: ${{ inputs.php-version }}
      if: inputs.validate-php-phpmd

    - run: npm ci @studyportals/code-style@$(jq -r '.devDependencies."@studyportals/code-style"' package.json) --no-save
    
    - run: |
        # ✅ Force Git to use HTTPS authentication with `GITHUB_TOKEN`
        git config --global url."https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/".insteadOf "https://github.com/"

        # ✅ Explicitly configure Composer to use GitHub OAuth
        composer config --global --auth github-oauth.github.com "${{ secrets.GITHUB_TOKEN }}"

        # ✅ Ensure Composer does NOT use SSH (force HTTPS)
        composer config --global repositories.stdypt git "https://github.com/studyportals/domain-api.git"

        # ✅ Clear Composer cache (to remove any old SSH attempts)
        composer clear-cache

        # ✅ Reinstall dependencies
        npm run configure || true
        composer require --dev phpmd/phpmd:$(jq -r '."require-dev"."phpmd/phpmd"' composer.json)
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      if: inputs.validate-php-phpmd


    - name: Read PHPMD version from composer.lock
      id: phpmd_version
      run: echo "PHPMD_VERSION=$(jq -r '.packages[] | select(.name == "phpmd/phpmd") | .version' composer.lock)" >> "$GITHUB_ENV"

    # - name: PHP Mess Detector
    #   uses: php-actions/phpmd@v1
    #   with:
    #     version: 2.8.0
    #     php_version: ${{ inputs.php-version }}
    #     path: ${{ steps.files.outputs.added_modified_renamed }}
    #     output: text
    #     ruleset: phpmd.xml
    #   if: inputs.validate-php-phpmd

        
    - run: |
        if [ ! -z "${{ steps.files.outputs.added_modified_renamed }}" ]; then
          echo "Linting changed files..."
          ./vendor/bin/phpmd ${{ steps.files.outputs.added_modified_renamed }} text phpmd.xml
        fi
      if: inputs.validate-php-phpmd

    - run: cat .github/super-linter.env >> "$GITHUB_ENV"

    - uses: super-linter/super-linter/slim@v6
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
